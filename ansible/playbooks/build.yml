---
- name: Build native_node (CMake/Ninja)
  hosts: local
  vars:
    build_dir: build
    cmake_opts: "-DCMAKE_BUILD_TYPE=Release -DENGINE_JIT=ON -DUSE_CLANGREPL=ON"
  tasks:
    - name: Create build directory
      file:
        path: "{{ build_dir }}"
        state: directory

    - name: Run CMake configure
      command: cmake -S . -B {{ build_dir }} -G Ninja {{ cmake_opts }}
      args:
        chdir: "{{ playbook_dir }}/../.."

    - name: Build project
      command: cmake --build {{ build_dir }} --config Release -j $(nproc)
      args:
        chdir: "{{ playbook_dir }}/../.."

    - name: Run ctest (smoke tests)
      command: ctest -V
      args:
        chdir: "{{ playbook_dir }}/../.."
      register: ctest_res
      failed_when: false

    - name: Save ctest results to artifact
      copy:
        content: "{{ ctest_res.stdout }}"
        dest: ./artifacts/ctest_output.txt
      delegate_to: localhost
