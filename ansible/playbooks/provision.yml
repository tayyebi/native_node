---
- name: Provision build/test host (Ubuntu/Debian focused)
  hosts: local
  become: true
  vars:
    pkg_list:
      - build-essential
      - cmake
      - ninja-build
      - clang
      - wget
      - ca-certificates
      - git
      - pkg-config
      - libseccomp-dev
      - sqlite3
      - python3-venv
      - python3-pip

  tasks:
    - name: Ensure apt cache is up to date
      apt:
        update_cache: yes
      failed_when: false

    - name: Install prerequisites for Kitware APT repo (for newer CMake)
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - gnupg
          - wget
        state: present

    - name: Add Kitware APT key and repository (for CMake >= 3.22)
      block:
        - name: Download Kitware GPG key and install
          shell: |
            wget -qO - https://apt.kitware.com/keys/kitware-archive-latest.asc | gpg --dearmor -o /usr/share/keyrings/kitware-archive-keyring.gpg
          args:
            creates: /usr/share/keyrings/kitware-archive-keyring.gpg
          ignore_errors: yes

        - name: Add Kitware apt repository
          copy:
            dest: /etc/apt/sources.list.d/kitware.list
            content: 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ {{ ansible_distribution_release }} main'
      when: ansible_facts['os_family'] == 'Debian'

    - name: Update apt after adding Kitware repo
      apt:
        update_cache: yes
      failed_when: false

    - name: Check installed cmake version
      command: cmake --version
      register: cmake_check
      failed_when: false

    - name: Install CMake via pip if system cmake is older than 3.22
      pip:
        name: 'cmake>=3.22'
        executable: pip3
      when: cmake_check.rc != 0 or (cmake_check.stdout is defined and (cmake_check.stdout.split('\n')[0].split()[2] is version('3.22', '<')))
      ignore_errors: yes

    - name: Install required packages
      apt:
        name: "{{ pkg_list }}"
        state: present

    - name: Install clang-repl if available in repos (best-effort)
      apt:
        name: clang-repl
        state: present
      ignore_errors: yes

    - name: Check if ninja is available
      command: ninja --version
      register: ninja_check
      failed_when: false

    - name: Install ninja via pip if missing
      pip:
        name: ninja
      when: ninja_check.rc != 0
      ignore_errors: yes

    - name: Ensure pytest available for running tests (optional)
      apt:
        name: python3-pytest
        state: present
      ignore_errors: yes

    - name: Try to install pytest via pip as fallback (best-effort)
      pip:
        name: pytest
        executable: pip3
      ignore_errors: yes

    - name: Show installed kernel version
      command: uname -r
      register: kernel_version

    - name: Print kernel version
      debug:
        var: kernel_version.stdout
