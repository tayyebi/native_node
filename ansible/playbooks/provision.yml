---
- name: Provision build/test host (Ubuntu/Debian focused)
  hosts: local
  become: true
  vars:
    pkg_list:
      - build-essential
      - cmake
      - ninja-build
      - clang
      - wget
      - ca-certificates
      - git
      - pkg-config
      - libseccomp-dev
      - sqlite3
      - python3-venv
      - python3-pip

  tasks:
    - name: Ensure apt cache is up to date
      apt:
        update_cache: yes

    - name: Install required packages
      apt:
        name: "{{ pkg_list }}"
        state: present

    - name: Install clang-repl if available in repos (best-effort)
      apt:
        name: clang-repl
        state: present
      ignore_errors: yes

    - name: Ensure ninja package available via pip as fallback
      pip:
        name: ninja
      when: "ansible_facts.packages.get('ninja-build') is not defined"

    - name: Ensure pytest available for running tests (optional)
      pip:
        name: pytest
        executable: pip3

    - name: Show installed kernel version
      command: uname -r
      register: kernel_version

    - name: Print kernel version
      debug:
        var: kernel_version.stdout
